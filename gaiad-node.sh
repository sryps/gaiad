#!/bin/bash
### TESTED WITH UBUNTU 22.04
### Run as root but not best practises - TESTING ONLY

set -e
cd
clear

echo "update packages and install dependencies..."
sudo apt update -y
sudo apt-get install -y make gcc jq git

# INSTALL GOLANG
echo "install go..."
curl -OL https://golang.org/dl/go1.19.3.linux-amd64.tar.gz

sudo tar -C /usr/local -xvf go1.19.3.linux-amd64.tar.gz

echo 'export GOROOT=/usr/local/go' >> ~/.profile
echo 'export GOPATH=$HOME/go' >> ~/.profile
echo 'export PATH=$GOPATH/bin:$GOROOT/bin:$PATH' >> ~/.profile

source ~/.profile
rm go1.19.3.linux-amd64.tar.gz


# INSTALL GAIAD
echo "install gaiad"
cd ~
git clone -b v7.1.0 https://github.com/cosmos/gaia
cd ~/gaia 
make install

gaiad init temp --chain-id temp-1

PEERS=4290b23119a4d16d3e3f21c329ddb6222ceb8711@65.21.145.163:26656,dd53fa5cfb6a604feb80860d47506d0dd84baa12@142.132.210.234:26656,7b8ab74fa7c3cc10b203b990abfc86e1a0b82a79@34.254.201.211:26656,32bdba6ced12cdf2e534566e6c3d66ee2f7ef494@84.244.95.229:26656,17f4ea9897e4885969b7ff444a814b178c102ecc@51.15.20.45:26656,e829d4764a5cecc44b3414777853b34407b36601@185.16.39.179:26656,be6a3c78962d1dff8e79bfa6548ea40d837d8640@86.111.48.34:26656,87ccc1dcc0b846fc1623ab9a5ab55682e8e2ad2e@47.156.153.124:26656,dee3771d222681139d9df18d4e127d4f52820614@65.108.142.81:26656,b9b99fbf40189c604ea618c4b99c61abc1489b70@18.140.125.215:26656,57b3ec821a394c243a856b2c82cfb59b7830b0ac@65.108.98.218:19095,932720552727174194287602fa9ca7e5ed881a52@159.69.168.236:26656,a2a5fde3f105c87299bb98fa798888914b85e6e7@65.109.21.76:26656,dd02e65e4a4374a40ab8f85de3038757becc7f33@159.69.168.249:26656,5d45bc48f6c0199c047e685fafb4309f53593f37@5.161.119.242:49656,d0238198ffa7f4db9a5d8c7b131c73f8382f8c47@65.108.141.109:30656,dff07399aeadf3f1b6edfac07f92a238112d3036@93.189.30.120:26656,6cceba286b498d4a1931f85e35ea0fa433373057@188.40.156.153:26656,5e1c4b422c5a0d14f97e93875d3f97242342ed6f@207.154.225.10:26656,ab7370e0af17b3fb10c912e722ff05e6e6505fc4@52.76.189.151:26656,3c08dde641866bf332e1a9f94261a39d57247328@65.108.230.27:26656,091406bc130d82b6902dbe0c8871bc21d6a4a9ba@18.220.233.222:26656,a2bd6a63813bba08e2b8504f6eace00d088cff82@23.88.18.142:26656,0b27d23a50a6969a22b268ec90a198c31b741b2d@65.108.103.184:27656,538348fa1eac998dad392a3f00f7b957042c3e84@15.235.53.86:11156,c165ffcdd4aaaf32b52de89b0c179b8b8b2a698d@18.139.2.24:26656,4d4df0f3e9578074606a104dd24f2c5f50ed7c1d@65.108.203.149:24656,44594a57ce538a21f8558bcb1c9ce560ad879e3e@15.235.114.84:26656,b79e1d3a621bdafd3a8d9a49dff8f4737d0bedc9@52.73.168.104:26656,3a94f1021e84bb54a640e5b1c1fe16827824e4f7@51.79.20.217:26656,f1b16c603f3a0e59f0ce5179dc80f549a7ecd0e2@35.227.127.218:26656,eb07fd614ebdb1a832fa85faf8265d38ae931cbb@35.242.253.68:26656,2e6f37cfbc4549c23f4ec48e9de68203858b62fc@51.38.52.99:26656,213857e741833d17275ea559bb2d0342398cec99@35.245.206.45:26656,d2aa9f06ffbe623ecf9fb123602179961d63d8a2@34.162.26.168:26656,e0ab6c5cc86959853f499236b8297344802ac5f4@5.161.139.201:26656,9cef7c4f9509d39415f8a202c5defac0a374ff4e@147.182.225.175:31547,b332dfdf64b7125f8d6ed380f2af45d303633a5e@3.138.194.177:26656,61bb33c7869e1d5014c996299a818d816ae961a6@52.77.137.184:26656,a0aca8fb801c69653a290bd44872e8457f8b0982@47.99.180.54:26656,9e14c8c48776a789f7029e88c260b2a6cbbf1417@35.245.8.174:26656,8dc4fd0007c74bdf4b7ee1e5a3ab68161cc8f845@142.132.208.213:26656,9c116194f25fd0d146019f171ef0f49904dcc586@167.86.98.230:26656,344d87e04fdf04be760da5069a59d9a489b886a6@52.14.44.1:26656,64871e238df997cfd4e498938dda344634ba6c21@65.108.201.46:26656,d0dfd28c708e61f42524c7bb6c1e4f6fb2856a55@119.123.69.228:26656,64148c47e1424173e3dcf90ab90bf196c2971b15@88.218.224.118:26656,76c65af180735315774497698ccf2091fb81284e@34.141.50.37:26656,546dfe618ddfe9a403d612f77442423294f8e8cb@87.98.155.164:26656,a303a7e56b3bc10d326c9ed2a98fc18118c95a5e@95.216.46.251:26656,b533749dfe0dc09eff1dfb2adf83108f9125ee1c@162.55.97.111:26656,4ced94cd9bb0b8c314559f878c4dff16ca3cf24b@138.201.63.42:26656,36564cfcb2d3a7b48ccb9b7d189dbf614e908988@18.188.143.199:26656,f58fa3aa606d321863effe34cfc7b22cfbfcbc2c@51.91.7.44:26656,f9243f02b606fee1c3ecbccc2056bcf303732800@198.244.179.141:26656,9e367e42b5dff11f12107582cb21a2a3aa97aca1@139.162.165.214:26656,75867e4ebc976b2691ba78d73ada8857ea5250e6@18.135.253.203:26656,07fc76b0a1dfcd25e3139a339728d50507bb5d96@67.209.54.35:26656,1d02b4300c6b6fd1123a20502f0b3c0ce3b73654@88.198.16.9:26656,b3663019968de0e9d9419eb12d96ae2977da9474@15.235.50.143:26656,915a5d104236764e33d5f7fd8d6c946e66766723@35.229.64.91:26656,84cc83cd09a974a234a3fdb5bb4fd46fd856f8ec@142.132.135.239:26656,2441e90fcb341fcd5bebec15b54e346cdca64a9b@135.148.123.8:14956,701036e718d0746d1d7055fb0fd1245cf361e0b8@168.119.79.106:26656,73c2a86cc0d4b51c81bd0e36cee69f1731bcda0d@23.88.69.157:26656,a94dff85ed430f0475f41fe306c82b7eb7f6e858@51.91.153.78:31649,322efd4fdc72a189a2fc8b2b597927831df2bbed@128.0.51.9:26656,ba3bacc714817218562f743178228f23678b2873@34.141.15.99:26656,f5f8b96406a165d486be243723bfa7291db1cf62@35.230.170.155:26656,f40a6e7d7168a3f2a5362cd37cbe6eac7a686056@185.229.119.178:26656,009c889254f9f49d9511ebb5cfa47855e4f41e82@54.38.46.179:26656,89c643c1f8bee0eaa680a304eb067905df986643@95.217.122.233:26656,03a3c841227b08a37baf792eabae7f68027a059b@162.55.238.6:36656,31f4526db58c663a8e395fee20d098e9df6f8303@35.245.94.116:26656,2633bc088bcf96209b695734005952906b5c45e3@3.123.191.80:26656,aea820ece7c45c0a8b5dababc9ea813f7eb62638@93.186.201.125:26656,75655e84a895fb3363b5f3ba107ff8166b357797@3.145.9.147:26656,c1e437f73b8889b78ea34981e7c349157ad80284@107.135.15.66:26656,10e3acd4baeb6cba8881d75a0bde04b5526b39ce@52.203.105.100:26656,27ad834c62dbefc5beb74be7575515927bd07c58@193.176.85.151:26656,53b3651680ec3482d736808cbb3035940107f8ab@185.146.148.119:26656,57b6404b031f6513bde381cfb8f3e96a6024e8ee@51.79.20.234:26656,c6f03336e99b15b104048a1af056063107389441@18.142.7.52:26656,34f0e424f747f62e04e8c34fde60013fb4dbc04b@65.108.0.165:14956,505f4467926cdad29932c44dc5ea7a5da6982f48@176.9.101.44:26656,1e77fd4ae92b74b1f4e25db6fbc199bc7619e2f4@108.161.223.131:26656,49469964d46155511be3f7b240856ebb15c1d1d2@34.91.103.185:26656,8352e66b77b4a16bac0dcb82746bfc09cbb11e6b@15.235.115.156:26656,71409c23ff950971f28a6c9111378b3c38b92484@65.108.99.37:26716,90a572b126de59fb924b050669e3d0851c7e8dd1@89.149.218.130:26656,c940e11c1072dad06da3b1b48ca92966bb37e93a@74.96.207.58:28721,05eb7aa1fd8251ed7a650c13da406df022b298b6@195.201.56.108:26656,1da54d20c7339713f1d6d28dd2117087dd33d0ca@154.53.32.78:26656,7bae77119cd833ae399cbfc2584e339058dd5f47@195.201.63.87:26656,918217aa0a52100aa3b83b267be6a6a798081873@95.216.98.181:26656,f701e3e0b7983c5a9e8ef34f88acd82ebd661c87@64.44.148.194:26656,cf10a45ead9e76d45b06dee97ef779e65103c78e@3.128.185.235:26656,dbfe1c6e0a95fa0052e186f7b52fe828baa87fbc@52.49.74.20:26656,6395f3d2e3d314dd642448918078e611056d0d26@94.250.201.132:26656,c1934aae3e251a4fdc54c67285a9ed18b5c9ed92@34.94.9.240:26656,9755cab2585a2794453a5b396ef13b893393366f@65.108.212.224:46671
sed -i.bak -e "s/^persistent_peers *=.*/persistent_peers = \"$PEERS\"/" $HOME/.gaia/config/config.toml

rm ~/.gaia/config/genesis.json
wget https://raw.githubusercontent.com/cosmos/mainnet/master/genesis/genesis.cosmoshub-4.json.gz
gzip -d genesis.cosmoshub-4.json.gz
mv genesis.cosmoshub-4.json ~/.gaia/config/genesis.json

sed -i.bak -E "s|^(pruning[[:space:]]+=[[:space:]]+).*$|\1\"custom\"| ; \
s|^(pruning-keep-every[[:space:]]+=[[:space:]]+).*$|\10| ; \
s|^(minimum-gas-prices[[:space:]]+=[[:space:]]+).*$|\1\"0.002uatom\"| ; \
s|^(pruning-keep-recent[[:space:]]+=[[:space:]]+).*$|\1500| ; \
s|^(pruning-interval[[:space:]]+=[[:space:]]+).*$|\1100| ; \
s|^(snapshot-interval[[:space:]]+=[[:space:]]+).*$|\12000| ; \
s|^(snapshot-keep-recent[[:space:]]+=[[:space:]]+).*$|\12|" $HOME/.gaia/config/app.toml


SNAP_RPC="https://cosmos-rpc.polkachu.com:443"

LATEST_HEIGHT=$(curl -s $SNAP_RPC/block | jq -r .result.block.header.height); \
BLOCK_HEIGHT=$((LATEST_HEIGHT - 2000)); \
TRUST_HASH=$(curl -s "$SNAP_RPC/block?height=$BLOCK_HEIGHT" | jq -r .result.block_id.hash)

sed -i.bak -E "s|^(enable[[:space:]]+=[[:space:]]+).*$|\1true| ; \
s|^(rpc_servers[[:space:]]+=[[:space:]]+).*$|\1\"$SNAP_RPC,$SNAP_RPC\"| ; \
s|^(trust_height[[:space:]]+=[[:space:]]+).*$|\1$BLOCK_HEIGHT| ; \
s|^(trust_hash[[:space:]]+=[[:space:]]+).*$|\1\"$TRUST_HASH\"|" $HOME/.gaia/config/config.toml


echo "create systemd service & start syncing..."
cat > /etc/systemd/system/gaiad.service << EOF
[Unit]
Description=gaiad
Wants=network-online.target
[Service]
User=root
ExecStart=/root/go/bin/gaiad start
Restart=always
RestartSec=10
[Install]
WantedBy=multi-user.target
EOF
source ~/.profile
systemctl daemon-reload
systemctl enable gaiad
systemctl start gaiad
journalctl -u gaiad.service -f
